<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>User Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    max-width: 600px;
  }
  input, button {
    padding: 0.5rem;
    margin: 0.25rem 0;
    width: 100%;
  }
  #dashboard {
    display: none;
  }
  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 1rem;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 0.5rem;
  }
  th {
    background: #f4f4f4;
  }
  #error {
    color: red;
  }
</style>
</head>
<body>

<h2>Login</h2>
<div id="loginForm">
  <input type="text" id="userId" placeholder="User ID" />
  <input type="password" id="userKey" placeholder="User Key" />
  <button id="loginBtn">Login</button>
  <p id="error"></p>
</div>

<div id="dashboard">
  <h2>Welcome, <span id="userName"></span></h2>
  <p>Balance: <span id="userBalance"></span></p>
  
  <h3>Make a Transfer</h3>
  <input type="text" id="receiverId" placeholder="Receiver User ID" />
  <input type="number" id="transferAmount" placeholder="Amount" min="1" />
  <button id="transferBtn">Send</button>
  <p id="transferError" style="color:red"></p>
  <p id="transferSuccess" style="color:green"></p>

  <h3>Your Transactions</h3>
  <table id="transactionsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Sender</th>
        <th>Receiver</th>
        <th>Amount</th>
        <th>Timestamp</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="logoutBtn" style="margin-top:1rem;">Logout</button>
</div>
<script>
  const loginForm = document.getElementById("loginForm");
  const dashboard = document.getElementById("dashboard");
  const userNameSpan = document.getElementById("userName");
  const userBalanceSpan = document.getElementById("userBalance");
  const errorP = document.getElementById("error");
  const transferError = document.getElementById("transferError");
  const transferSuccess = document.getElementById("transferSuccess");
  const transactionsTableBody = document.querySelector("#transactionsTable tbody");

  // Helper to do login fetch with user & key
  async function doLogin(user, key) {
    errorP.textContent = "";
    try {
      const res = await fetch(`/api/login?user=${encodeURIComponent(user)}&key=${encodeURIComponent(key)}`);
      const data = await res.json();
      if (!res.ok) {
        throw new Error(data.error || "Login failed.");
      }
      // Show dashboard
      loginForm.style.display = "none";
      dashboard.style.display = "block";
      userNameSpan.textContent = user;
      userBalanceSpan.textContent = data.user.count;
      populateTransactions(data.transactions);
      // Save credentials to localStorage for persistence
      localStorage.setItem("userId", user);
      localStorage.setItem("userKey", key);
    } catch (err) {
      errorP.textContent = err.message;
      logoutCleanup();
    }
  }

  // On page load, try auto-login if credentials saved
  window.onload = () => {
    const savedUser = localStorage.getItem("userId");
    const savedKey = localStorage.getItem("userKey");
    if (savedUser && savedKey) {
      doLogin(savedUser, savedKey);
    }
  };

  // Manual login button click
  document.getElementById("loginBtn").onclick = () => {
    const user = document.getElementById("userId").value.trim();
    const key = document.getElementById("userKey").value.trim();
    if (!user || !key) {
      errorP.textContent = "Please enter user ID and key.";
      return;
    }
    doLogin(user, key);
  };

  function populateTransactions(transactions) {
    transactionsTableBody.innerHTML = "";
    transactions.forEach((tx) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${tx.id}</td>
        <td>${tx.sender_id}</td>
        <td>${tx.receiver_id}</td>
        <td>${tx.amount}</td>
        <td>${new Date(tx.timestamp).toLocaleString()}</td>
      `;
      transactionsTableBody.appendChild(row);
    });
  }

  document.getElementById("transferBtn").onclick = async () => {
    transferError.textContent = "";
    transferSuccess.textContent = "";
    const receiver = document.getElementById("receiverId").value.trim();
    const amount = parseInt(document.getElementById("transferAmount").value, 10);
    const user = localStorage.getItem("userId");
    const key = localStorage.getItem("userKey");

    if (!receiver || isNaN(amount) || amount <= 0) {
      transferError.textContent = "Please enter a valid receiver and amount.";
      return;
    }
    if (!user || !key) {
      transferError.textContent = "Not logged in.";
      return;
    }

    try {
      // Pass sender user and key in the URL (key is required by your API)
      const res = await fetch(
        `/api/change?send=${encodeURIComponent(user)}&rev=${encodeURIComponent(receiver)}&key=${encodeURIComponent(key)}&amount=${amount}`
      );
      const data = await res.json();
      if (!res.ok) {
        transferError.textContent = data.error || "Transfer failed.";
        return;
      }
      transferSuccess.textContent = `Transfer successful! New balance: ${data.senderNewCount}`;
      userBalanceSpan.textContent = data.senderNewCount;

      // Refresh transactions - just re-login to refresh all data cleanly
      await doLogin(user, key);

      // Clear input
      document.getElementById("receiverId").value = "";
      document.getElementById("transferAmount").value = "";
    } catch (e) {
      transferError.textContent = "Network error.";
    }
  };

  // Clear localStorage and reset UI on logout or failed login
  function logoutCleanup() {
    localStorage.removeItem("userId");
    localStorage.removeItem("userKey");
    dashboard.style.display = "none";
    loginForm.style.display = "block";
    errorP.textContent = "";
    transferError.textContent = "";
    transferSuccess.textContent = "";
    transactionsTableBody.innerHTML = "";
    document.getElementById("userId").value = "";
    document.getElementById("userKey").value = "";
  }

  document.getElementById("logoutBtn").onclick = async () => {
    try {
      const res = await fetch("/api/logout");
      if (res.ok) {
        logoutCleanup();
      } else {
        const data = await res.json();
        alert(data.error || "Logout failed.");
      }
    } catch {
      alert("Network error.");
    }
  };
</script>

</body>
</html>
