<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bank System</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 5px; }
    .hidden { display: none; }
    .section { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
  </style>
</head>
<body>
  <h1>Bank System</h1>

  <div id="loginDiv">
    <h2>Login</h2>
    <input id="loginId" placeholder="User ID" />
    <input id="loginPass" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>

  <div id="userDiv" class="hidden">
    <h2>Welcome <span id="userName"></span></h2>
    <button onclick="logout()">Logout</button>

    <div class="section" id="accountsSection">
      <h3>Accounts</h3>
      <ul id="accountsList"></ul>
    </div>

    <div class="section" id="transactionsSection">
      <h3>Transactions</h3>
      <ul id="transactionsList"></ul>
    </div>

    <div class="section" id="transferSection">
      <h3>Transfer Money</h3>
      <input id="fromAccount" placeholder="From Account ID" />
      <input id="toAccount" placeholder="To Account ID" />
      <input id="transferAmount" type="number" placeholder="Amount" />
      <button onclick="transferMoney()">Transfer</button>
    </div>

    <div class="section hidden" id="adminSection">
      <h3>Admin Controls</h3>

      <h4>Create User</h4>
      <input id="newUserId" placeholder="User ID" />
      <input id="newUserPass" placeholder="Password" />
      <button onclick="createUser()">Create User</button>

      <h4>Create Account</h4>
      <input id="newAccId" placeholder="Account ID" />
      <input id="newAccOwner" placeholder="Owner ID" />
      <input id="newAccBalance" placeholder="Initial Balance" type="number" />
      <button onclick="createAccount()">Create Account</button>

      <h4>Delete User</h4>
      <input id="delUserId" placeholder="User ID" />
      <button onclick="deleteUser()">Delete User</button>

      <h4>Delete Account</h4>
      <input id="delAccId" placeholder="Account ID" />
      <button onclick="deleteAccount()">Delete Account</button>
    </div>
  </div>

  <script>
    let isAdmin = false;

    async function login() {
      const id = document.getElementById("loginId").value;
      const password = document.getElementById("loginPass").value;

      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, password })
      });

      const data = await res.json();

      if (!data.success) return alert(data.error);

      isAdmin = data.isAdmin;

      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("userDiv").classList.remove("hidden");
      document.getElementById("userName").textContent = id;

      if (isAdmin) {
        document.getElementById("adminSection").classList.remove("hidden");
      }

      loadAccounts();
      loadTransactions();
    }

    async function logout() {
      await fetch("/api/logout");
      location.reload();
    }

    async function loadAccounts() {
      const res = await fetch("/api/accounts");
      const accounts = await res.json();
      const list = document.getElementById("accountsList");
      list.innerHTML = accounts.map(a => `<li>Account: ${a.id} \n Owner: ${a.owner_id} \n Balance: $${a.balance}</li>`).join("");
    }

    async function loadTransactions() {
      const res = await fetch("/api/transactions");
      const txns = await res.json();
      const list = document.getElementById("transactionsList");
      list.innerHTML = txns.map(t => `<li>${t.sender_account} transfered ${t.receiver_account} the sum of $${t.amount} (${t.timestamp})</li>`).join("");
    }

    async function createUser() {
      const id = document.getElementById("newUserId").value;
      const pass = document.getElementById("newUserPass").value;

      const res = await fetch("/api/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, password: pass })
      });

      const data = await res.json();
      alert(data.success ? "User created" : data.error);
    }

    async function deleteUser() {
      const id = document.getElementById("delUserId").value;

      const res = await fetch(`/api/users/${id}`, { method: "DELETE" });
      const data = await res.json();
      alert(data.success ? "User deleted" : data.error);
    }

    async function createAccount() {
      const id = document.getElementById("newAccId").value;
      const owner_id = document.getElementById("newAccOwner").value;
      const balance = parseInt(document.getElementById("newAccBalance").value) || 0;

      const res = await fetch("/api/accounts", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, owner_id, balance })
      });

      const data = await res.json();
      alert(data.success ? "Account created" : data.error);
      loadAccounts();
    }

    async function deleteAccount() {
      const id = document.getElementById("delAccId").value;

      const res = await fetch(`/api/accounts/${id}`, { method: "DELETE" });
      const data = await res.json();
      alert(data.success ? "Account deleted" : data.error);
      loadAccounts();
    }

    // TRANSFER MONEY
    async function transferMoney() {
      const from = document.getElementById("fromAccount").value;
      const to = document.getElementById("toAccount").value;
      const amount = parseFloat(document.getElementById("transferAmount").value);

      if (!from || !to || !amount || amount <= 0) {
        return alert("Please enter valid transfer details");
      }

      const res = await fetch("/api/transfer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ from, to, amount })
      });

      const data = await res.json();
      if (data.success) {
        alert(`Transfer successful! Transaction ID: ${data.transactionId}`);
        loadAccounts();
        loadTransactions();
      } else {
        alert(data.error || "Transfer failed");
      }
    }
  </script>
</body>
</html>
